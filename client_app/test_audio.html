<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Test - Voice Bot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        h1 {
            color: #4CAF50;
            margin-bottom: 20px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: #3a3a3a;
        }
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
            background: #252525;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”Š Audio Playback Test</h1>
        
        <div>
            <button onclick="testLocalAudio()">Test 1: Play Local Test Sound</button>
            <button onclick="testBase64Audio()">Test 2: Play Base64 Audio</button>
            <button onclick="connectAndTest()" id="connectBtn">Test 3: Connect to Server & Get Real Audio</button>
        </div>
        
        <div id="status">
            <strong>Status:</strong> <span id="statusText">Ready to test</span>
        </div>
        
        <div id="log"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        };

        const updateStatus = (text, type = 'info') => {
            const statusText = document.getElementById('statusText');
            statusText.textContent = text;
            statusText.className = type;
        };

        // Test 1: Try to play a simple beep
        function testLocalAudio() {
            log('Testing local audio playback...', 'info');
            
            // Create a simple beep using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 440; // A4 note
            oscillator.type = 'sine';
            gainNode.gain.value = 0.3;
            
            oscillator.start();
            setTimeout(() => {
                oscillator.stop();
                log('âœ“ Local audio playback test completed!', 'success');
                updateStatus('Audio system is working!', 'success');
            }, 500);
        }

        // Test 2: Try to play a base64-encoded MP3
        async function testBase64Audio() {
            log('Testing base64 MP3 playback...', 'info');
            
            // This is a tiny silent MP3 file (base64 encoded)
            const silentMp3 = 'SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4T+W8SlAAAAAAD/+xDEAAADSAAAAAAAAABKgAAAAgAAA0gAAAAAAAAApQAAABg==';
            
            try {
                const audio = new Audio('data:audio/mp3;base64,' + silentMp3);
                
                audio.onloadeddata = () => {
                    log('âœ“ Base64 MP3 loaded successfully', 'success');
                };
                
                audio.oncanplay = () => {
                    log('âœ“ Audio is ready to play', 'success');
                };
                
                audio.onerror = (e) => {
                    log(`âœ— Audio error event: ${audio.error?.message || 'Unknown'}`, 'error');
                };
                
                await audio.play();
                log('âœ“ Base64 MP3 playback test completed!', 'success');
                updateStatus('Browser can play base64 MP3!', 'success');
                
            } catch (error) {
                log(`âœ— Base64 audio playback failed: ${error.message}`, 'error');
                updateStatus('Base64 audio playback failed', 'error');
            }
        }

        // Test 3: Connect to server and get real TTS audio
        let ws = null;
        async function connectAndTest() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            
            try {
                log('Connecting to server...', 'info');
                updateStatus('Connecting...', 'info');
                
                ws = new WebSocket('ws://127.0.0.1:8000/ws');
                
                ws.onopen = () => {
                    log('âœ“ Connected to server!', 'success');
                    updateStatus('Connected to server', 'success');
                    
                    // Simulate a speech event to trigger TTS
                    setTimeout(() => {
                        log('Sending test audio to trigger TTS...', 'info');
                        
                        // Create a fake audio buffer (just zeros)
                        const fakeAudioBuffer = new Uint8Array(16000).fill(0);
                        const base64Audio = btoa(String.fromCharCode.apply(null, fakeAudioBuffer));
                        
                        ws.send(JSON.stringify({
                            type: 'speech_end',
                            audio: base64Audio,
                            timestamp: Date.now()
                        }));
                        
                        log('Sent test audio. Waiting for TTS response...', 'info');
                    }, 1000);
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    log(`â† Received: ${data.event}`, 'info');
                    
                    if (data.event === 'play_audio' && data.audio) {
                        log('ðŸ”Š Received audio from server! Attempting playback...', 'success');
                        log(`   Audio data length: ${data.audio.length} chars`, 'info');
                        
                        // Server sends MP3 from gTTS
                        const audio = new Audio('data:audio/mp3;base64,' + data.audio);
                        
                        audio.onloadeddata = () => {
                            log('âœ“ Audio loaded successfully', 'success');
                        };
                        
                        audio.oncanplay = () => {
                            log('âœ“ Audio is ready to play', 'success');
                        };
                        
                        audio.onerror = (e) => {
                            log(`âœ— Audio error: ${audio.error?.message || 'Unknown'}`, 'error');
                        };
                        
                        audio.play()
                            .then(() => {
                                log('âœ“ Audio playback started successfully!', 'success');
                                updateStatus('Audio playback working!', 'success');
                            })
                            .catch(err => {
                                log(`âœ— Audio playback error: ${err.message}`, 'error');
                                updateStatus('Audio playback failed', 'error');
                            });
                    }
                };
                
                ws.onerror = (error) => {
                    log('âœ— WebSocket error', 'error');
                    console.error('WebSocket error:', error);
                    updateStatus('Connection error', 'error');
                    btn.disabled = false;
                };
                
                ws.onclose = () => {
                    log('âœ— Disconnected from server', 'info');
                    updateStatus('Disconnected', 'info');
                    btn.disabled = false;
                };
                
            } catch (error) {
                log(`âœ— Connection error: ${error.message}`, 'error');
                updateStatus('Connection failed', 'error');
                btn.disabled = false;
            }
        }

        // Initial message
        log('Audio test page loaded. Click buttons to test!', 'info');
    </script>
</body>
</html>

